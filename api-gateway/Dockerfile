# Construction stage
FROM node:21.7.1-alpine AS build

WORKDIR /gateway

RUN npm install -g pnpm

COPY package*.json ./
RUN pnpm i

COPY . .

# app config development
ARG DOMAIN
ARG PORT
ARG API_PREFIX
ARG API_VERSION

# security
ARG JWT_SECRET
ARG ALGORITHM

# Microservices
ARG BROKER

# users microservice
ARG USERS_MICROSERVICE_NAME

# product microservice
ARG PRODUCT_MICROSERVICE_NAME

# inventory microservice
ARG INVENTORY_MICROSERVICE_NAME

# inventory microservice
ARG ORDER_MICROSERVICE_NAME

# payment microservice
ARG PAYMENT_MICROSERVICE_NAME

ENV DOMAIN=$DOMAIN
ENV PORT=$PORT
ENV API_PREFIX=$API_PREFIX
ENV API_VERSION=$API_VERSION
ENV JWT_SECRET=$JWT_SECRET
ENV ALGORITHM=$ALGORITHM
ENV BROKER=$BROKER
ENV USERS_MICROSERVICE_NAME=$USERS_MICROSERVICE_NAME
ENV PRODUCT_MICROSERVICE_NAME=$PRODUCT_MICROSERVICE_NAME
ENV INVENTORY_MICROSERVICE_NAME=$INVENTORY_MICROSERVICE_NAME
ENV ORDER_MICROSERVICE_NAME=$ORDER_MICROSERVICE_NAME
ENV PAYMENT_MICROSERVICE_NAME=$PAYMENT_MICROSERVICE_NAME

RUN pnpm run build

# Final stage
FROM node:21.7.1-alpine

RUN apk add --no-cache tini

RUN npm install -g pnpm

WORKDIR /gateway

# Copy only the files compiled and needed to run the application.
COPY --from=build /gateway/dist ./dist
COPY --from=build /gateway/node_modules ./node_modules
COPY --from=build /gateway/package.json ./package.json

# app config development
ARG DOMAIN
ARG PORT
ARG API_PREFIX
ARG API_VERSION

# security
ARG JWT_SECRET
ARG ALGORITHM

# Microservices
ARG REDIS_HOST
ARG REDIS_PORT

# users microservice
ARG USERS_MICROSERVICE_NAME

# product microservice
ARG PRODUCT_MICROSERVICE_NAME

# inventory microservice
ARG INVENTORY_MICROSERVICE_NAME

# inventory microservice
ARG ORDER_MICROSERVICE_NAME

# payment microservice
ARG PAYMENT_MICROSERVICE_NAME

ENV DOMAIN=$DOMAIN
ENV PORT=$PORT
ENV API_PREFIX=$API_PREFIX
ENV API_VERSION=$API_VERSION
ENV JWT_SECRET=$JWT_SECRET
ENV ALGORITHM=$ALGORITHM
ENV BROKER=$BROKER
ENV REDIS_HOST=$REDIS_HOST
ENV REDIS_PORT=$REDIS_PORT
ENV USERS_MICROSERVICE_NAME=$USERS_MICROSERVICE_NAME
ENV PRODUCT_MICROSERVICE_NAME=$PRODUCT_MICROSERVICE_NAME
ENV INVENTORY_MICROSERVICE_NAME=$INVENTORY_MICROSERVICE_NAME
ENV ORDER_MICROSERVICE_NAME=$ORDER_MICROSERVICE_NAME
ENV PAYMENT_MICROSERVICE_NAME=$PAYMENT_MICROSERVICE_NAME

ENTRYPOINT ["/sbin/tini", "--"]

EXPOSE $PORT

CMD [ "pnpm", "run", "start:prod" ]